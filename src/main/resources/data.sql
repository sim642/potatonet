SET SCHEMA PUBLIC;

DROP VIEW V_FEED IF EXISTS;

CREATE VIEW V_FEED AS
SELECT POST.*, TBL_FRIENDS.PERSON_ID AS FEED_USER_ID
FROM POST
JOIN TBL_FRIENDS ON POST.USER_ID=TBL_FRIENDS.FRIEND_ID
UNION
SELECT POST.*, POST.USER_ID AS FEED_USER_ID
FROM POST
ORDER BY CREATION_DATE_TIME DESC;


DROP VIEW V_USER_FEED IF EXISTS;

CREATE VIEW V_USER_FEED AS
SELECT POST.*, POST.USER_ID AS FEED_USER_ID
FROM POST
ORDER BY CREATION_DATE_TIME DESC;


CREATE TABLE IF NOT EXISTS POST_LIKE  (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1)
  post_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
CONSTRAINT like_pk PRIMARY KEY (user_id, post_id),
CONSTRAINT fk_like_to_post FOREIGN KEY (post_id) REFERENCES POST,
CONSTRAINT fk_like_to_user FOREIGN KEY (user_id) REFERENCES USER
);

DROP VIEW V_POST_LIKE IF EXISTS;

CREATE VIEW V_POST_LIKE AS SELECT POST_LIKE.* FROM POST_LIKE;

CREATE PROCEDURE ADD_LIKE(added_post_id BIGINT, added_user_id BIGINT)
  MODIFIES SQL DATA
  INSERT INTO POST_LIKE VALUES (added_post_id, added_user_id);

CREATE PROCEDURE REMOVE_LIKE(removed_post_id BIGINT, removed_user_id BIGINT)
  MODIFIES SQL DATA
  DELETE FROM POST_LIKE WHERE post_id=removed_post_id AND user_id=removed_user_id;
